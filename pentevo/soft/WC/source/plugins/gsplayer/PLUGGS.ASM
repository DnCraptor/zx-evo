;GS Player v0.89;(C) KOSHI/MGN/2024;---------------------------------------        SAVEBIN "gsplayer.wmf";---------------------------------------INTpSEC  EQU 49MODPLAY  EQU #31MODSTOP  EQU #32MODCONT  EQU #33VOLUME   EQU #35MODPOZ   EQU #60PATPOZ   EQU #61GS_SOFTRESET    EQU #F3GS_GETRAMINFO   EQU #23GS_LOAD_MODULE  EQU #30;__GS_OPEN_STREAM  EQU #D1; /GS_CLOSE_STREAM EQU #D2;/;---------------------------------------        ORG #6000;-------        INCL "prtgs.asm";-------ABT     EQU #6004ENT     EQU #6005WLD     EQU #6006;---------------------------------------;HEADER:        DS 16        DB "WildCommanderMDL";    Header        DB #0F;                  Version        DB 0;                       Type        DB 1; Pages        DB 0; Page to #8000;-------        DB 0,13; CODE.5      DB 0,0;-------        DS 16;-------        DB "MOD"        DB "WAV"        DB "MP3"        DS 29*3;-------        DB 0;-------        DW #FFFF,#FFFF; MAX SIZE;-------        DB "GS Player v0.89 "        DB "                ";-------        DB 0;---------------------------------------        ORG #8000,#6200;-------PG0     EQU 0;start pagePGS     EQU 5;pages totalTIMEOUT EQU INTpSEC*4LOBU2   EQU #A000LOBU    EQU #C000;---------------------------------------PLUGIN  LD (DAHL),HL,(DADE),DE        LD (FILENAME),BC        EXA:LD (EXTnow+1),A        LD L,H,H,E.3      SRL D:RR H,L        INC L:JR NZ,$+3:INC H        LD (BLKZ),HL        XOR A        LD (ESTAT),A        LD (ANFNT+1),A        INC A        LD (MODSTATE),A        CALL DEVCHE:RET Z        LD A,(GSENA):CP #FF:CALL Z,GSFET        LD A,(GSENA):OR A:JP NZ,NOGS        LD HL,#FFFF,(TMM),HL        LD HL,TMMI,A,#FF:CALL INT_PL        LD A,#DF        LD (SPR+MAINWW+8),A        LD (SPR+MAINWW+18),A        LD (SPR+MAINWW*2+8),A        LD (SPR+MAINWW*2+18),A        CALL GEDPL        CALL TENTRY        CALL ANFNTEXTnow  LD A,0        OR A:JR Z,MODMUZ        DEC A:JP Z,WAVMUZ        DEC A:JP Z,MP3MUZ;-------MODMUZ  LD IX,MNWND:CALL PRWOW        LD A,(IX+3):ADD A,(IX+5):SUB MAINAH+1:LD (MODWND+3),A        CALL GOGS        CALL PBCLC        XOR A        LD (POZA),A        LD (POZP),A        LD (POZoPAT),A        LD (CMDWAIT),A        LD HL,#FFFF,(TMM),HL:INC HL:LD (TMMOUT),HL        PUSH IX        LD IX,MODWND:CALL PRWOW        LD HL,MODUND,DE,MODH*256+1,BC,MODW-2:CALL PRSRW        LD A,%00001111:CALL PRIAT        POP IXMAIN    EI:HALT:CALL GWC,NC,PTCC:JR NC,NEXTnMUTE        CALL SPKE:JR NZ,GAFF        CALL ESC:JR NZ,MGAFF        CALL ENKE:JR NZ,NEXTnMUTE        LD A,(CMDWAIT):OR A:JR NZ,NYA        LD A,1:CALL KBSCN:CP "m":CALL Z,PLAYMUTENYA     CALL GWC,NC,PTC:JR NC,NEXTnMUTE        CALL PRINT_PATTERN_WIND        JR MAINNEXTnMUTE CALL MUTEGSNEXT    LD A,2,(ESTAT),AGAFF    PUSH IX:LD A,(EXTnow+1),IX,MODWND:OR A:CALL Z,RRESB        POP IX:CALL RRESB        CALL DEFNTGAF     LD A,(ESTAT)        RET;-------MGAFF   CALL MUTEGS:JR GAFF;-------NOGS    LD A,1,(ESTAT),A:JR GAF;---------------------------------------TMMI    LD HL,(TMM):INC HL:LD A,L:OR H:RET Z        LD A,(MODSTATE):OR A:RET Z        LD (TMM),HL        LD HL,(TMMOUT):INC HL        LD (TMMOUT),HL        RET;---------------------------------------PTCC    LD A,(MODSTATE):OR A:JR Z,POF        CALL CLOCK,PBPRINTPTC     LD A,(MODSTATE):OR A:JR Z,POF        CALL PBLNE,PATTERN        LD HL,TIMEOUT,DE,(TMMOUT):SBC HL,DE:JR C,NNC        LD A,(CMDWAIT):XOR 1:LD (CMDWAIT),A:JR Z,POZREAD        LD A,PATPOZ:CALL SNDCOM        JR POFPOZREAD CALL GTDAT        LD HL,POZP,DE,0        CP (HL):JR Z,POZR:LD (TMMOUT),DEPOZR    LD (HL),A:OR A:JR NZ,PROF        LD A,(POZoPAT):OR A:JR Z,POF        LD HL,POZA:INC (HL)        LD A,(POZS):CP (HL):JR C,NNC,Z,NNC        XOR A        JR PROF+2PROF    LD A,1,(POZoPAT),APOF     SCF        RETNNC     XOR A        RET;---------------------------------------PLAYMUTE LD A,(MODSTATE):XOR 1:LD (MODSTATE),A:JR Z,MODPAUSE         LD A,MODCONT:CALL SNDCOM         XOR A         RETMODPAUSE LD A,MODSTOP:CALL SNDCOM         XOR A         RET;---------------------------------------PATTERN PUSH HL,DE,BC        LD HL,PATTERNN,A,(PAT1):CALL NORK8BIT        LD HL,POSITIONN,A,(POZA):INC A:CALL NORK8BIT        LD HL,SONGLENGTHN,A,(POZS):CALL NORK8BIT        LD HL,PATTERN_NUMBER,DE,#0501:CALL TXTPR        POP BC,DE,HL        RETMOD_SONG_LENGTH    EQU LOBU+950MOD_SONG_POSITIONS EQU LOBU+952;0-127 positions: 0-63 patterns (128 bytes)MOD_PATTERNS       EQU LOBU+1084;(1024 bytes/pattern);------------------PATTERN_TO_START   ;i:  A - Song Position;                   o: HL - Pattern Address (#C000-#FFFF);                       A - Pattern Page (at #C000)                   LD HL,MOD_PATTERNS:OR A:RET Z.2                 ADD A,A                   LD B,#40                   SUB B:LD C,0:JR C,PTS                   SUB B:LD C,1:JR C,PTS                   SUB B:LD C,2:JR C,PTS                   SUB B                   LD C,3PTS                ADD A,B:LD B,A,A,C                   LD C,0:ADD HL,BC                   RET;------------------PRINT_PATTERN_WIND PUSH IX                   LD A,PG0:CALL MNGCVPL                   LD IX,MODWND                   LD A,(POZA),BC,MOD_SONG_POSITIONS,H,0,L,A:ADD HL,BC                   LD A,(HL):INC HL                   LD (PAT1),A         EXA:LD A,(HL):CALL PATTERN_TO_START:LD (PATTERN_NOW2),HL,(PATTERN_NOW2_PG),A         EXA:CALL PATTERN_TO_START:LD (PATTERN_NOW),HL,(PATTERN_NOW_PG),A,(PGC),A                   LD A,(POZP),(POZP2),A:OR A:JR Z,PPW                   LD BC,HL                   LD H,0,L,A.4                 ADD HL,HL                   ADD HL,BCPPW                LD DE,#0101                   LD B,7PWIND              PUSH BC                   CALL PATTERN_POSITION_UPDATE                   CALL PRINT_PATTERN_LINE                   POP BC:DJNZ PWIND                   POP IX                   RETPRINT_PATTERN_LINE ;i:HL - data;                     DE - YX;                   o:HL - next;                     DE - next                   PUSH DE                   CALL READ_CHANNEL;CHA                   PUSH HL:LD HL,CHA_SAMPLE:CALL DECODE_SAMPLEFFECT                   POP HL                   CALL READ_CHANNEL;CHB                   PUSH HL:LD HL,CHB_SAMPLE:CALL DECODE_SAMPLEFFECT                   POP HL                   CALL READ_CHANNEL;CHC                   PUSH HL:LD HL,CHC_SAMPLE:CALL DECODE_SAMPLEFFECT                   POP HL                   CALL READ_CHANNEL;CHD                   PUSH HL:LD HL,CHD_SAMPLE:CALL DECODE_SAMPLEFFECT                   POP HL                   POP DE                   PUSH HL:LD HL,PATTERNLINEPATTERN:CALL TXTPR                   POP HL                   RET;------------------READ_CHANNEL       ;i:HL - data in pattern;                   o:HL - next poz;                     DE - Effect command 12 bits;                     BC - Note 12 bits period;                      A - Sample number                   LD A,(HL):AND #F0:LD (PATTERN_SAMPLE),A                   LD A,(HL):INC HL:AND #0F:LD B,A;Note upper 4 bits                   LD C,(HL):INC HL;Note lower 8 bits                   LD A,(HL):SRL A,A,A,A:OR 0;Sample numberPATTERN_SAMPLE     EQU $-1                   PUSH AF                   LD A,(HL):INC HL:AND #0F:LD D,A;Effect command upper 4 bits                   LD E,(HL):INC HL;Effect command lower 8 bits                   POP AF                   RET;------------------NOTE_FND           DEC HL                   LD BC,PERIOD_TABLE:OR A:SBC HL,BC:ADD HL,HL                   LD BC,NOTES:ADD HL,BC                   LD BC,3:LDIR                   JR NOTE_NOTEDECODE_SAMPLEFFECT ;i: HL - Offset in TXT Buffer;                      DE - Effect command 12 bits;                      BC - Note 12 bits;                       A - Sample number;                   o: HL - New value                   PUSH AF,DE                   EX DE,HL                   LD A,B:OR C:JR Z,NONOTE                   LD HL,PERIOD_TABLENEXT_NOT2          LD A,C:CP (HL):INC HL:JR NZ,NEXT_NOTE                   LD A,B:CP (HL):JR Z,NOTE_FNDNEXT_NOTE          INC HL                   LD A,H:CP PERIOD_TABLE_END[:JR C,NEXT_NOT2                   LD A,L:CP PERIOD_TABLE_END]:JR C,NEXT_NOT2                   LD HL,NOTE_MISS:JR $+2+3NONOTE             LD HL,NOTE_ZERO,BC,3:LDIRNOTE_NOTE          EX DE,HLSAMPLEFFECT        POP DE,AF.3                 INC HL                   CALL NORK8BIT:INC HL.2                 INC HL                   LD A,D:CALL NORK4BIT                   LD A,E:CALL NORK8BIT                   RETNORK8BIT           ;i:HL - Address;                      A - value                   INC HL:LD C,A:AND %00001111:CP 10:JR C,$+4:ADD A,7,A,#30                   LD (HL),A:DEC HL:LD (HL),C                   XOR A:RLD:CP 10:JR C,$+4:ADD A,7,A,#30:LD (HL),A:INC HL,HL                   RETNORK4BIT           ;i:HL - Address;                      A - value                   AND %00001111:CP 10:JR C,$+4:ADD A,7,A,#30                   LD (HL),A:INC HL                   RET;------------------PATTERN_POSITION_UPDATE PUSH HL                        LD HL,POZP2,A,(HL):CP #40:JR C,PPU                        POP BC:LD BC,(PATTERN_NOW2)                        PUSH BC                        LD A,(PATTERN_NOW2_PG),(PGC),A                        XOR A:LD (HL),APPU                     INC (HL)                        LD HL,PATTERN_POZ:CALL NORK8BIT                        LD A,(PGC):CALL PATTERN_PAGES                        POP HL                        RET;------------------PATTERN_PAGES      ;i: A - Page                   PUSH DE                   PUSH AF:CALL MNGCVPL                   POP AF:INC A                   CALL MNG0VPL                   POP DE                   RET;------------------PATTERNLINEPATTERN DB 7,7PATTERN_POZ        DB "00",7,7,#DD                   DB 1CHA_SAMPLE         DB "--- ",6,6                   DB "00 ",4,4,"000",7,7,#DD                   DB 1CHB_SAMPLE         DB "--- ",6,6                   DB "00 ",4,4,"000",7,7,#DD                   DB 1CHC_SAMPLE         DB "--- ",6,6                   DB "00 ",4,4,"000",7,7,#DD                   DB 1CHD_SAMPLE         DB "--- ",6,6                   DB "00 ",4,4,"000",0PATTERN_NUMBER     DB #E,"Pattern:",6,6,"#"PATTERNN           DB "00  "                   DB 7,7,"Position:",6,6,"#"POSITIONN          DB "00  ",7,7,"Length:",6,6,"#"SONGLENGTHN        DB "00",#D                   DB 0;------------------NOTES DB "C-0 ","C#0 ","D-0 ","D#0 ","E-0 ","F-0 ","F#0 ","G-0 ","G#0 ","A-0 ","A#0 ","B-0 " DB "C-1 ","C#1 ","D-1 ","D#1 ","E-1 ","F-1 ","F#1 ","G-1 ","G#1 ","A-1 ","A#1 ","B-1 " DB "C-2 ","C#2 ","D-2 ","D#2 ","E-2 ","F-2 ","F#2 ","G-2 ","G#2 ","A-2 ","A#2 ","B-2 " DB "C-3 ","C#3 ","D-3 ","D#3 ","E-3 ","F-3 ","F#3 ","G-3 ","G#3 ","A-3 ","A#3 ","B-3 " DB "C-4 ","C#4 ","D-4 ","D#4 ","E-4 ","F-4 ","F#4 ","G-4 ","G#4 ","A-4 ","A#4 ","B-4 "NOTE_ZERO          DB "---"NOTE_MISS          DB "***"PERIOD_TABLE       DW 1712,1616,1524,1440,1356,1280,1208,1140,1076,1016,960,906                   DW 856,808,762,720,678,640,604,570,538,508,480,453                   DW 428,404,381,360,339,320,302,285,269,254,240,226                   DW 214,202,190,180,170,160,151,143,135,127,120,113                   DW 107,101,95,90,85,80,75,71,67,63,60,56PERIOD_TABLE_END;------------------PGC                NOPPATTERN_NOW_PG     NOPPATTERN_NOW2_PG    NOPPATTERN_NOW        DW 0PATTERN_NOW2       DW 0;---------------------------------------GOGS    CALL PBSHWLSL     EQU 28_LD HL,LOADING_SPRITE,DE,#0101+(MAINWW-LSL)/2,BC,LSL:CALL PRSRW;Loading..._LD A,%01111110:CALL PRIAT_LD HL,LOADING_SPRITE+LSL,DE,#0201+(MAINWW-LSL)/2,BC,LSL:CALL PRSRW_LD A,%01111110:CALL PRIAT_LD HL,LOADING_SPRITE+LSL*2,DE,#0301+(MAINWW-LSL)/2,BC,LSL:CALL PRSRW_LD A,%01111110:CALL PRIAT_LD HL,LOADING_SPRITE,DE,#0F01+(MAINWW-LSL)/2,BC,LSL:CALL PRSRW;Loading..._LD A,%01111110:CALL PRIAT_LD HL,LOADING_SPRITE+LSL,DE,#1001+(MAINWW-LSL)/2,BC,LSL:CALL PRSRW_LD A,%01111110:CALL PRIAT_LD HL,LOADING_SPRITE+LSL*2,DE,#1101+(MAINWW-LSL)/2,BC,LSL:CALL PRSRW_LD A,%01111110:CALL PRIAT        XOR A:CALL SENDCOM;RESET FLAGS (DATAandCOMMAND)        LD A,GS_SOFTRESET:CALL SENDCOM;REini        LD A,GS_GETRAMINFO:CALL SENDCOM,GETDAT        EXA        LD A,GS_LOAD_MODULE:CALL SENDCOM;sndMOD        LD A,GS_OPEN_STREAM:CALL SENDCOM;opnSTRM        EXA        LD DE,6,H,D,L,A.4      ADD HL,HL        ADD HL,DE        LD A,(BLKZ+1):CP H        JR NZ,ZEM        LD B,A:LD A,(BLKZ):CP L:LD A,B        JR Z,NOIZEM     JP NC,BRKANOI     OR A:JR Z,NANOIR    PUSH AF        LD B,0:CALL GSLOAD        POP AF        DEC A:JR NZ,NOIRNA      LD A,(BLKZ),B,A        CALL GSLOAD        LD A,GS_CLOSE_STREAM:CALL SENDCOM        IN A,(#B3):OUT (#B3),A;MODULE NUMBER        LD A,MODPLAY:CALL SNDCOM;-------        CALL GIPAGPL;poz file at start              LD C,PG0LOAD_PATTERNS PUSH BC:LD A,C:CALL MNGCVPL:LD HL,LOBU,B,32:CALL LOAD512              POP BC:CP #0F:JR Z,LPE:INC C:LD A,C:CP PG0+PGS:JR C,LOAD_PATTERNSLPE           LD A,PG0:CALL MNGCVPL          LD A,(MOD_SONG_LENGTH),(POZS),A          LD HL,LOBU,DE,TXT2,B,CONTLNG          CALL FLLNAME          LD HL,TXT2,DE,#0C01+TITLELNG,BC,20:CALL PRSRW          ;LD A,%01111110:CALL PRIAT          LD HL,MODE1,DE,EDITOR0FILE_INFO PUSH DE,HL          LD HL,(FILENAME),DE,TXT2,B,CONTLNG:CALL FLLNAME          LD HL,TXT2,DE,#0B01+TITLELNG,BC,CONTLNG:CALL PRSRW          ;LD A,%01111110:CALL PRIAT          POP HL:LD DE,#0901+TITLElng:CALL TXTPR          POP HL:LD DE,#0801+TITLElng:CALL TXTPR          RETFLLNAME LD A,(HL):OR A:JR NZ,$+5:LD A," ":DEC HL        INC HL:LD (DE),A:INC DE        DJNZ FLLNAME        RETBRKA    LD A,#D2:CALL SENDCOM        RET;---------------------------------------GSLOAD  PUSH BC        CALL PBPR        LD HL,LOBU2,B,4:CALL LOAD512        LD HL,LOBU2        LD BC,#00BB,E,2TE1     IN A:RLCA:JR C,TE1RDA     LD A,(HL):OUT (#B3),A:INC LTE2     IN A:RLCA:JR C,TE2RDB     LD A,(HL):OUT (#B3),A:INC LTE3     IN A:RLCA:JR C,TE3RDC     LD A,(HL):OUT (#B3),A:INC LTE4     IN A:RLCA:JR C,TE4RDD     LD A,(HL):OUT (#B3),A:INC HL        DJNZ TE1:DEC E:JR NZ,TE1        POP BC        DJNZ GSLOAD        RET;-------SNDCOM  OUT (#BB),A:RETSENDCOM OUT (#BB),AGSWC    IN A,(#BB)        RRCA        JR C,GSWC        RETGWC     IN A,(#BB):RRCA:RET;-------SENDDAT OUT (#B3),AGSWD    IN A,(#BB):RLCA:JR C,GSWD:RET;-------GETDAT  IN A,(#BB):RLCA:JR NC,GETDATGTDAT   IN A,(#B3)        RETGWD     IN A,(#BB):RLCA:RET;---------------------------------------GSFET   LD A,#80:OUT (#33)        LD B,32:EI:HALT:DJNZ $-2        IN A,(#B3)        LD B,0,C,ASTAB    IN A,(#B3):CP C:JR NZ,WSE        DJNZ STAB        LD A,#23:OUT (#BB),A        LD BC,#0F00DIK     DEC BC:LD A,B:OR C:JR Z,WSE        IN A,(#BB)        RRCA        JR C,DIK        IN A,(#B3):CP 3:JR C,WSEWNE     LD A,1:OUT (#B3),A        LD A,#6A:CALL SENDCOM        XOR A:OUT (#B3),A        LD A,#6B:CALL SENDCOM        XOR A;-------WZE     LD (GSENA),A        PUSH AF:LD A,#F3:CALL SNDCOM        POP AF        RETWSE     LD A,1:OR A        JR WZE;-------MUTEGS  LD A,#F3:OUT (#BB):RET;---------------------------------------WAVMUZ  LD IX,MN2WND:CALL PRWOW        LD HL,LOBU2,B,1:CALL LOAD512        LD BC,(LOBU2+24);4 BYTES!;-------        EXX:LD HL,WAV_8000:EXX:LD HL,8000,DE,#0504:OR A:SBC HL,BC:JR Z,GC        EXX:LD HL,WAV_11025:EXX:LD HL,11025,DE,#0403:OR A:SBC HL,BC:JR Z,GC        EXX:LD HL,WAV_16000:EXX:LD HL,16000,DE,#0302:OR A:SBC HL,BC:JR Z,GC;TMP        EXX:LD HL,WAV_22050:EXX:LD HL,22050,DE,#0102:OR A:SBC HL,BC:JR Z,GC        EXX:LD HL,WAV_44100:EXX:LD HL,44100,DE,#0101:OR A:SBC HL,BC:JR Z,GC;37.5KHz!;-------GC      LD A,(LOBU2+22)        LD BC,WAV_MONO        LD HL,#0000:CP 1:JR Z,CHANLZ        LD BC,WAV_STEREO        LD HL,#7E23:CP 2:JR Z,CHANLZCHANLZ  LD (TOGS+5),HL;STEREO        LD (TOGS+3),DE;FREQ        LD (WAV_CHAN),BC:EXX:LD (WAV_FREQ),HL        LD HL,MODE2,DE,EDITOR0:CALL FILE_INFO        LD HL,WAV_MODE,DE,#050A:CALL TXTPR        CALL PBSHW        XOR A        OUT (#B3),A        OUT (#BB),A        IN A,(#BB)        LD A,#F3:CALL SENDCOM        LD A,#00:OUT (#B3),A        LD A,#14:CALL SENDCOM,GSWD        LD A,#02:CALL SENDDAT        LD A,#00:CALL SENDDAT        LD A,#40:CALL SENDDAT        LD HL,TOGS,BC,#0200WAV2    PUSH BC        LD A,(HL):CALL SENDDAT:INC HL        POP BC        DEC BC:LD A,B:OR C:JR NZ,WAV2        XOR A:OUT (#B3)        LD A,#13:CALL SENDCOM,GSWD        LD A,#40:CALL SENDDAT        XOR A:OUT (#BB),A        IN A,(#B3)        XOR A        LD (WVMD),A        LD A,32        LD (MINB),A        LD A,(BLKZ+1):OR A:JR Z,MNI        LD B,ABIG     LD C,0:CALL BG:JR NZ,NX        DJNZ BIGMNI     LD A,(BLKZ):OR A:JR Z,EDWV        LD C,A:CALL BG:JR NZ,NX        LD A,1,(WVMD),AEDWV    LD A,#FF:CALL SENDCOM        CALL ENKE        LD A,(WVMD):OR A:JP Z,GAFF        JP NEXT;-------NX      DEC A:JR NZ,EXWVNXWV    LD A,1,(WVMD),AEXWV    LD A,#FE        JR EDWV+2;-------BG      PUSH BC:LD B,1:CALL GSLOAD        CALL CLOCK        POP BC        LD HL,MINB        LD A,(HL):OR A:JR Z,FFF        DEC (HL)        XOR A        LD (ABT),A        LD (ENT),A        JR HHHFFF     LD A,(ENT):OR A:JR NZ,NXF        LD A,(ABT):OR A:JR NZ,EXFHHH     DEC C:JR NZ,BG        XOR A        RET;-------NXF     LD A,1:OR A:RETEXF     LD A,2:OR A:RET;---------------------------------------MP3MUZ  LD IX,MN2WND:CALL PRWOW        CALL PBSHW        LD HL,MODE3,DE,EDITOR0:CALL FILE_INFO;-------        LD HL,MP3HR,A,(HL):OR A:JR Z,DAK        XOR A:LD (MP3TOGS),ADAK     LD (HL),1;-------        XOR A        OUT (#B3),A        OUT (#BB),A        IN A,(#BB)        LD A,#F3:CALL SENDCOM        LD A,#00:OUT (#B3),A        LD A,#14:CALL SENDCOM,GSWD        LD A,#04:CALL SENDDAT        LD A,#00:CALL SENDDAT        LD A,#40:CALL SENDDAT        LD HL,MP3TOGS,BC,#0400        JP WAV2;---------------------------------------PBSHW   LD HL,(DAHL)        LD DE,(DADE).5      SRL D:RR E,H,L        LD (PBSTL+1),HL        LD (PBSTH+1),DE        LD HL,0,(PBNOW),HL,(PBNOW+2),HL        RET;-------PBPR    LD HL,(PBNOW)        LD DE,(PBNOW+2)        LD BC,2048        ADD HL,BC:JR NC,$+3:INC DE        LD (PBNOW),HL        LD (PBNOW+2),DE        PUSH IX        CALL DELIT4P        POP IX        LD HL,TXTBU        LD C,32        OR A:JR NZ,$+5:LD A,C:JR DoL        CP C:JR C,$+3:LD A,C        LD B,A        LD A,C:SUB B        LD C,11,(HL),C:INC HL:DJNZ $-2        OR A:RET ZDoL     LD B,A,C,19,(HL),C:INC HL:DJNZ $-2        LD A,(TXTBU+32),(TXTBU+31),A        LD HL,LOADPB,DE,#0401+(MAINWW-34)/2,BC,33:CALL PRSRW        RET;---------------------------------------PBLNE   LD A,(POZA):OR A:CALL Z,PBCLR        INC A        LD H,0,L,A.3      ADD HL,HL        LD DE,HL        LD B,PBWIDTHMNOGA   ADD HL,DE:DJNZ MNOGAPBSTP   LD DE,0        LD A,D:OR E:JR Z,PBCLR        LD BC,0-1:OR A:INC BC:SBC HL,DE:JP NC,$-3        LD HL,PBWIDTH*8:OR A:SBC HL,BC:JR NC,$+5:LD BC,PBWIDTH*8        LD HL,PBLINE        LD A,C.3      SRL B:RR C        JR Z,PBL        LD B,CFLPB    LD (HL),19:INC HL:DJNZ FLPBPBL     AND 7:RET Z        LD DE,PBTBL-1        LD B,A:INC DE:DJNZ $-1        LD A,(DE),(HL),A        RETPBCLR   LD HL,PBLINE        PUSH AF        LD B,PBWIDTH,A,11CFPB    LD (HL),A:INC HL:DJNZ CFPB        POP AF        RETPBTBL   DB 12,13,14,15,16,17,18;-------PBCLC   CALL PBCLR        LD A,(POZS),(PBSTP+1),A        RET;---------------------------------------DELIT4P LD IX,0-1NAZE    OR APBSTH   LD BC,0:INC IX        EX DE,HL:SBC HL,BC:JR C,NDPBSTL   LD BC,0        EX DE,HL:SBC HL,BC:JR NC,PBSTH        DEC DE        LD A,D:INC A:JR NZ,NAZE        LD A,E:INC A:JR NZ,NAZE        INC DE        ADD HL,BC        EX DE,HL        LD BC,(PBSTH+1)ND      ADD HL,BC        EX DE,HL        PUSH IX        POP BC        LD A,C        RET;---------------------------------------;---------------------------------------DEVCHE  LD A,(IX+29):CP 2:RET NZ        CALL GEDPL        LD IX,ERWND:CALL PRWOW_LD HL,TXTER,DE,#0103,BC,26:CALL PRSRW        CALL USPO        CALL NUSP        CALL RRESB        XOR A        RET;---------------------------------------CLOCK   LD HL,(TMM):INC HL        LD A,L:OR H:DEC HL:JR NZ,Clock        INC HL:LD (TMM),HLClock   LD DE,CLOK        LD BC,49*60,A,255        OR A:INC A:SBC HL,BC:JP NC,$-3        LD (DE),A:INC DE        ADD HL,BC        LD BC,49,A,255        OR A:INC A:SBC HL,BC:JP NC,$-3        LD (DE),A:INC DE        ADD HL,BC        LD A,L:ADD A,A        LD (DE),A        LD DE,SPR,A,(CLOK+0):CALL DEC0,PRDIS        LD DE,SPR+10,A,(CLOK+1):CALL DEC0,PRDIS        LD DE,SPR+20,A,(CLOK+2):CALL DEC0,PRDIS      LD HL,SPR+#00,DE,#0101+(MAINWW-28)/2,BC,28:CALL PRSRW:LD A,%01111111:CALL PRIAT      LD HL,SPR+MAINWW,DE,#0201+(MAINWW-28)/2,BC,28:CALL PRSRW:LD A,%01111111:CALL PRIAT      LD HL,SPR+MAINWW*2,DE,#0301+(MAINWW-28)/2,BC,28:CALL PRSRW:LD A,%01111111:CALL PRIAT        RETPBPRINT LD HL,SLINE,DE,#0401,BC,MAINWW:CALL PRSRW;LD HL,MODES,DE,#021F:CALL TXTPR        RETDEC0    LD C,#FF        INC C:SUB 10:JR NC,$-3        ADD A,10        RET;-------;Print DigitsPRDIS   ;i: DE - Dest Address;            C - Digit1;            A - Digit2          PUSH AF,DE        CALL GDF        POP DE,BC        LD C,B.4      INC DEGDF     LD H,0,L,C        PUSH HL.3      ADD HL,HL        POP BC        ADD HL,BC;*9        LD BC,DIGITS:ADD HL,BC        LD A,3DDF.3      LDI        EX DE,HL:LD BC,MAINWW-3:ADD HL,BC        EX DE,HL        DEC A:JR NZ,DDF        RET;---------------------------------------ANFNT   LD A,0:OR A:RET NZ        INC A:LD (ANFNT+1),A        LD A,#FF:EXA:XOR A:CALL WLD        LD HL,#C000,DE,#C800,BC,8*20        LDIR        LD HL,#C000,DE,#C001,BC,8*9-1        LD (HL),L        LDIR        LD HL,#C000+8+7,DE,8        LD C,%01111110        LD A,1AFN     PUSH HL        LD B,A,(HL),C:DEC HL:DJNZ $-2        POP HL        ADD HL,DE        INC A:CP 9:JR C,AFN;-------        LD HL,PBRMK,DE,#C000+8*9,BC,8*3:LDIR        LD HL,DE,BC,0-8:ADD HL,BC        LD BC,8*8:LDIR        LD A,%10000000        LD B,8,HL,#C000+8*12+3,DE,8-1BUR     LD C,A        OR (HL):LD (HL),A:INC L        LD A,C        OR (HL):LD (HL),A        LD A,C        ADD HL,DE        SCF:RRA        DJNZ BUR        RETDEFNT   LD A,#FF:CALL MNGC_PL        LD HL,#C800,DE,#C000,BC,8*20        LDIR        RET;---------------------------------------MNGC_PL EXA:XOR A:JP WLDPRWOW   LD A,1:JP WLDRRESB   LD A,2:JP WLDPRSRW   LD A,3:JP WLDPRIAT   EXA:LD A,4:JP WLDGADRW   LD A,5:JP WLDTXTPR   LD A,11:JP WLD;-------GEDPL   LD A,15:JP WLD;-------SPKE    LD A,16:JP WLDENKE    LD A,22:JP WLDESC     LD A,23:JP WLDKBSCN   EXA:LD A,42:JP WLDUSPO    LD A,46:JP WLDNUSP    LD A,47:JP WLD;-------LOAD512 LD A,48:JP WLDGIPAGPL LD A,50:JP WLDTENTRY  LD DE,ENTRY,A,51:JP WLD;-------MNGCVPL EXA:LD A,65:JP WLDMNG0VPL EXA:LD A,80:JP WLD;-------INT_PL  EXA:LD A,86:JP WLD;---------------------------------------MAINWW  EQU 46MAINY   EQU 255MAINW   EQU MAINWW+2MAINAH  EQU MODH-1MAINHH  EQU 12+2MAINH   EQU MAINAH+MAINHHMODW    EQU 46+2MODH    EQU 6+2MNWND   DB 4+16+128,0        DB 255,MAINY;   X,Y        DB MAINW,MAINH; W,H        DB %01111111;   PAPER+INK        DB 0        DW #0000;            BUFFER        DB MAINAH+3,MAINAH+6;LINES        DW MNTXTHEAD        DW 0        DW MNTXTBODYMN2WND  DB 4+16+128,0        DB 255,MAINY;    X,Y        DB MAINW,MAINHH; W,H        DB %01111111;    PAPER+INK        DB 0        DW #0000;        BUFFER        DB 3,6;          LINES        DW MNTXTHEAD        DW 0        DW MNTXTBODYMNTXTHEAD DB #E,9,"GS Player",0MNTXTBODY DS 7,#D          DB 2,"Editor:",#D          DB 2INFOTITLe DB "  Mode:"ETITLe    DB #D,#D          DB 1,"File:",#D          DB 1INFOTITLE DB "Name:"ETITLE    NOPTITLELNG  EQU ETITLE-INFOTITLETITLElng  EQU ETITLe-INFOTITLeCONTLNG   EQU MAINWW-TITLELNGMODWND  DB 4+16+128,0        DB 255,0;    X,Y        DB MODW,MODH;W,H        DB %01111111;PAPER+INK        DB 0        DW #0000;    BUFFER        DB 0,0;      LINES        DW TXTPAT        DW 0        DW 0TXTPAT  DB 9," M - Pause  ENTER - Next File SPACE - Keep Play",0MODUND  DS MODW-2,#F7;-------;PLWND   DB 3+16+128,0;        DB 255,255;  X,Y;        DB 32+2,2+2; W,H;        DB %01111111;PAPER+INK;        DB 0;        DW #0000;    BUFFER;        DB 0,0;      LINES;-------ERWND   DB 3+16+128,0        DB 255,255;  X,Y        DB 32+2,1+2; W,H        DB %00101111;PAPER+INK        DB 0        DW #0000;    BUFFER        DB 0,0;      LINES;-------TXT2    DS CONTLNGTXTER   DB "CAN'T PLAY FROM SD(NGS)!!!"MODE1   DB "MOD Player",0MODE2   DB "WAV Player",0MODE3   DB "MP3 Player",0WAV_MODE DB "8-bit WAV  "         DB #FEWAV_FREQ DW WAV_44100         DB "  "         DB #FEWAV_CHAN DW WAV_MONO         DB 0WAV_STEREO DB "Stereo",0WAV_MONO   DB "Mono",0WAV_8000  DB " 8000 Hz",0WAV_11025 DB "11025 Hz",0WAV_16000 DB "16000 Hz",0WAV_22050 DB "22050 Hz",0WAV_44100 DB "44100 Hz",0EDITOR0 DB "UNKNOWN",0;---------------------------------------DAHL    DS 2DADE    DS 2BLKZ    DS 2PBNOW   DS 4GSENA   DB #FFMP3HR   NOPMINB    NOPCMDWAIT NOPPOZoPAT NOPPAT1    NOP ;PATTERN NOWPOZP2   NOPPOZP    NOP ;POS in PATTERNPOZA    NOP ;POS NOWPOZS    NOP ;POSITIONSWVMD    NOP;-------TMMOUT  DS 2 ;Pattern Position Time OutTMM     DS 2 ;TimerCLOK    DS 3TIME    DB "00:00.00";-------ESTAT    NOPMODSTATE NOPFILENAME DW 0;---------------------------------------ENTRY   DS 32TXT32   DS 32,32LOADPB  DB 9TXTBU   DS 32        DB 10PBWIDTH EQU MAINWW-2SLINE   DB 9;       [PBLINE  DS PBWIDTH; PB body        DB 10;      ]LOADING_SPRITE DB #DC,#20,#20,32,#DC,#DC,#DC,32,#DC,#DC,#DC,32,#DC,#DC,#20:DB 32,#DC,#DC,#DC,32 DB #DC,#DC,#20,32,#DC,#DC,#DC,32 DB #DB,#20,#20,32,#DB,#20,#DB,32,#DB,#DC,#DB,32,#DB,#20,#DB:DB 32,#20,#DB,#20,32 DB #DB,#20,#DB,32,#DB,#20,#DC,32 DB #DB,#DC,#DC,32,#DB,#DC,#DB,32,#DB,#20,#DB,32,#DB,#DC,#DF:DB 32,#DC,#DB,#DC,32 DB #DB,#20,#DB,32,#DB,#DC,#DB,32DIGITS  DB #DC,#DC,#DC;0        DB #DB,#20,#DB        DB #DB,#DC,#DB        DB #20,#DC,#20;1        DB #DF,#DB,#20        DB #DC,#DB,#DC        DB #DC,#DC,#DC;2        DB #DC,#DC,#DB        DB #DB,#DC,#DC        DB #DC,#DC,#DC;3        DB #20,#DC,#DB        DB #DC,#DC,#DB        DB #DC,#20,#DC;4        DB #DB,#DC,#DB        DB #20,#20,#DB        DB #DC,#DC,#DC;5        DB #DB,#DC,#DC        DB #DC,#DC,#DB        DB #DC,#DC,#DC;6        DB #DB,#DC,#DC        DB #DB,#DC,#DB        DB #DC,#DC,#DC;7        DB #20,#20,#DB        DB #20,#20,#DB        DB #DC,#DC,#DC;8        DB #DB,#DC,#DB        DB #DB,#DC,#DB        DB #DC,#DC,#DC;9        DB #DB,#DC,#DB        DB #DC,#DC,#DBPBRMK   DB %00000000        DB %00000111        DB %00000110        DB %00000110        DB %00000110        DB %00000110        DB %00000111        DB %00000000        DB %00000000        DB %11100000        DB %01100000        DB %01100000        DB %01100000        DB %01100000        DB %11100000        DB %00000000        DB %00000000        DB %11111111        DB %00000000        DB %10101010        DB %01010101        DB %00000000        DB %11111111        DB %00000000SPR     DS MAINWW*3END;---------------------------------------TOGS    ORG #4000,#6200+END-PLUGINSTRWAV  DI:JR GONPEI     DB 2        DB 1STO     DB #00,#00GON     LD HL,I_n_T,(#5EFF),HL        LD A,#5E,I,A        IM 2;---------------------------------------        LD D,C_24MHZ        IN A,(GSCFG0)        AND #CF        OR D        OUT (GSCFG0),A;-------        LD A,63        OUT (#07),A        OUT (#08),A;     6,7,8,9=A,B,C,D        LD HL,PEI        LD A,(HL),(PE1+1),A:INC HL        LD A,(HL),(PE2+1),A        LD HL,(STO),(STEREO),HL        EXX:LD BC,#0100,HL,#8000,D,#61        EXX;---------------------------------------LOADE   LD A,1,(PAGR+1),ALDE     LD HL,PAGR+1:INC (HL)        LD A,(HL),DE,(MXP)        CP E:JR NC,TYU        OUT (#00),A        LD HL,#8000        CALL PGLD        JR LDETYU     OUT (#00),A        LD A,2,(PAG+1),A        EI        LD HL,#8000        LD BC,#02WAITGS  IN A,(#01):OR A:JR NZ,EXIT        IN A,(#04)        RLCA:JR NC,WAITGS        INI        LD A,H:OR L:JR NZ,WAITGS        LD H,#80;L=0        LD A,(PAGR+1),DE,(MXPG)        INC A:CP E:JR C,$+4:LD A,2        LD (PAGR+1),A,E,AKL      LD A,(PAG+1):CP E:JR Z,KL        JP WAITGSEXIT    INC A:JR NZ,FUCK        IN ANFIR    LD A,(PAGR+1),E,AEXT     LD A,(PAG+1):CP E:JR Z,NXS        LD A,H:CP #80:JR C,EXT        LD (HL),0:INC HL        JR EXTNXS     LD A,(PAG+1):CP E:JP NZ,#0000        JR NXS;-------FUCK    IN A        JP #0000;---------------------------------------I_n_T   EXX:EXA        DJNZ NOSND        LD A,C:OR A:JR NZ,K1PE2     LD B,4:INC C        JR PAGK1      CP 1:JR NZ,K2        INC C        JR $+4K2      LD C,0PE1     LD B,3PAG     LD A,2:OUT (#00),A        LD A,(HL)        LD (DE),A:INC DSTEREO  NOP:NOP        LD (DE),A        LD A,(DE):DEC D        LD A,(DE)        INC L:JR Z,POZPAGR    LD A,2:OUT (#00),ANOSND   EXX:EXA        EI        RET;-------POZ     INC H:JR NZ,PAGR        LD A,(MXPG),E,A,A,(PAG+1)        INC A:CP E:JR C,$+4:LD A,2        LD (PAG+1),A        LD H,#80        JR PAGR;---------------------------------------PGLD    IN A,(#04):RLCA:JR NC,PGLD        IN A,(#02)        LD (HL),A        INC HL:LD A,H:OR L:JR NZ,PGLD        RET;---------------------------------------INDEX   DW 0SND     DB 0MXPG    DB 8MXP     DB 4;-------END_WAV;---------------------------------------;---------------------------------------;--------------MP3 Driver---------------;---------------------------------------ORGSWAV EQU #6200+END-PLUGIN;-------        ORG #4000,ORGSWAV+END_WAV-STRWAV        DI        DI        LD SP,#5000        LD HL,I_U_T,(#5EFF),HL        LD A,#5E,I,A        IM 2;-------        CALL MP3INIT;-------        LD A,BPGB:OUT (#00),A        LD HL,#8000:CALL PGLD2;-------        EI        LD HL,#8000        LD DE,HLWAITNGS IN A,(#01):OR A:JR NZ,EXIT2        IN A,(#04)        RLCA:JR NC,WAITNGS        LD A,H:CP D:JR Z,$-2        IN A,(#02)        LD (HL),A        INC L:JP NZ,WAITNGS        INC H:JR NZ,WAITNGS        LD H,#80;L=0        JP WAITNGS;-------EXIT2   INC A:JR NZ,FUCK2        IN A,(#02)        LD A,H:DEC A        CP #80:JR NC,$+4:LD A,#F0        CP D:JR NZ,$-1        JR EAH;-------FUCK2   IN A,(#02)EAH     DI        LD HL,#C9FB,(I_U_T),HL        LD A,3:CALL FREQNC        JP #0000;---------------------------------------PGLD2   IN A,(#04):RLCA:JR NC,PGLD2        IN A,(#02)        LD (HL),A        INC L:JP NZ,PGLD2        INC H:JR NZ,PGLD2        RET;---------------------------------------I_U_T   EXA;-------        IN A,(SSTAT):RRA:JR NC,IUTE        LD A,D:INC A:JR Z,HUITE        CP H:JR Z,IUTEJATT    LD B,#20DATT    LD A,(DE):OUT (MD_SEND),A:INC DE        DJNZ DATT        LD A,D:OR E:JR Z,PZ2;-------IUTE    EXA        EI        RET;-------HUITE   ADD A,#80:CP H:JP NZ,JATT,IUTE;-------PZ2     LD DE,#8000:JP IUTE;---------------------------------------MP3INIT XOR A:CALL FREQNC;         10MHz        CALL HARDMP3;LD HL,#020B;LD DE,#0000;CALL COM_MP3        CALL SOFTMP3        RET;=======================================NOPER.32     NOP        RET;---------------------------------------FREQNC  LD D,C_10MHZ;#30        AND 3:JR Z,FREQNCS        LD D,C_12MHZ;#10        DEC A:JR Z,FREQNCS        LD D,C_20MHZ;#20        DEC A:JR Z,FREQNCS        LD D,C_24MHZ;0FREQNCS IN A,(GSCFG0)        AND #CF        OR D        OUT (GSCFG0),A        RET;---------------------------------------;HARD RESET:HARDMP3 LD A,(#4000):OR A:RET Z        XOR A:CALL VOL_MOD        LD BC,MC_SEND        LD A,%10011100:OUT (SCTRL),A        LD HL,#0301:CALL COM_MP3        LD A,E:AND %01110000        PUSH AF        LD A,M_MPXRS        OUT (SCTRL),A:CALL NOPER        LD A,M_MPXRS+M_SNCLR        OUT (SCTRL),A        IN A,(SSTAT):RRA:JR NC,$-3        LD HL,#0203;#8000+#9B58=7000        LD DE,#9B58:CALL COM_MP3        POP AF        LD HL,#0202        LD DE,#8008:CALL Z,COM_MP3        LD A,1:CALL FREQNC;        12MHz        RET;---------------------------------------;SOFT RESET:SOFTMP3 LD BC,MC_SEND        LD HL,#030B:CALL COM_MP3        PUSH DE        LD DE,#FEFE        LD HL,#020B:CALL COM_MP3        LD HL,#0301:CALL COM_MP3        LD A,E        AND %01110000        PUSH AF        LD HL,#0300:CALL COM_MP3        LD A,E:XOR 4:LD E,A        LD HL,#0200:CALL COM_MP3        LD A,E:XOR 4:LD E,A        LD HL,#0200:CALL COM_MP3        IN A,(SSTAT):RRA:JR NC,$-3        LD HL,#0203        LD DE,#9B58        CALL COM_MP3        POP AF        LD HL,#0202        LD DE,#8008:CALL Z,COM_MP3        POP DE        LD HL,#020B        JR COM_MP3;---------------------------------------VOL_MOD OUT (VOL1),A        OUT (VOL2),A        OUT (VOL3),A        OUT (VOL4),A        OUT (VOL5),A        OUT (VOL6),A        OUT (VOL7),A        OUT (VOL8),A        RET;---------------------------------------;i: H - Command (3-READ, 2-WRITE);   L - Register Address;  DE - ValueCOM_MP3 CALL NOPER        IN A,(SSTAT):RRA:JR NC,$-3        CALL NOPER        LD A,M_MCNCS:OUT (SCTRL),A        CALL NOPER        LD BC,MC_SEND        LD A,H        OUT H:CALL NOPER        OUT L:CALL NOPER        CP 3:JR Z,MP3READ        OUT D:CALL NOPER        OUT EMP3END  CALL NOPER        LD A,M_MCNCS+M_SNCLR;#82        OUT (SCTRL),A        JP NOPER;-------MP3READ LD BC,MC_READ,A,#FF        OUT (MC_SEND),A:CALL NOPER        IN D:CALL NOPER        OUT (MC_SEND),A:CALL NOPER        IN E        JR MP3END;=======================================MP3TOGS EQU ORGSWAV+END_WAV-STRWAV+#1E00;---------------------------------------BPGB    EQU 2BPGE    EQU 2;---------------------------------------